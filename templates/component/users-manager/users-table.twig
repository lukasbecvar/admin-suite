{% extends 'common/layout.twig' %}

{# USER MANAGER TABLE COMPONENT #}
{% block component %} 
<div class="users-manager">
    <div class="bg-neutral-900 border-b border-neutral-700 sub-navigation">
        {# GO TO RAW USERS DATABASE #}
        <a href="#" class="border border-neutral-500 font-bold px-1 text-white">
            <i class="fa fa-database" aria-hidden="true"></i>
        </a>

        {# LINK TO USER REGISTER FORM #}
        <a href={{ path('app_manager_users_register') }} class="border border-neutral-500 font-bold px-1 text-white">
            <i class="fa fa-plus" aria-hidden="true"></i>
        </a>

        {# FILTER FORM #}
        <span class="mr-1"></span>
        <div>
            <form method="get" action={{ path('app_manager_users') }}>
                <select name="filter" onchange="this.form.submit()" class="bg-neutral-800 text-white border border-neutral-500 rounded">
                    <option value="">All Users</option>
                    <option value="online" {% if filter == 'online' %}selected{% endif %}>Online</option>
                    <option value="banned" {% if filter == 'banned' %}selected{% endif %}>Banned</option>
                </select>
            </form>
        </div>
    </div>
    
    {# CHECK IF TABLE IS EMPTY #}
    {% if users|length == 0 %}
        <p class="flex items-center justify-center mt-20 mb-20 text-2xl text-white font-bold">This user list page is empty</p>
    {% else %}
        <div class="bg-neutral-900 border-b border-neutral-700 overflow-x-auto">
            <table class="min-w-full divide-y divide-white whitespace-nowrap">
                <thead>
                    <tr class="hover:bg-neutral-800 border-b border-neutral-600">
                        <th class="text-left text-white p-2">#</th>
                        <th class="text-left text-white p-2">Username</th>
                        <th class="text-left text-white p-2">Role</th>
                        <th class="text-left text-white p-2">Browser</th>
                        <th class="text-left text-white p-2">OS</th>
                        <th class="text-left text-white p-2">Last Login</th>
                        <th class="text-left text-white p-2">IP Address</th>
                        <th class="text-left text-white p-2">Status</th>
                        <th class="text-left text-white p-2">Banned</th>
                        <th class="text-left text-white p-2 text-center"><i class="fa fa-ban" aria-hidden="true"></th>
                        <th class="text-left text-white p-2"><i class="fa fa-trash" aria-hidden="true"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white font-bold">
                    {% for row in users %}
                        {# GET ONLINE STATUS #}
                        {% set isOnline = false %}
                        {% for onlineUser in onlineList %}
                            {% if row.id == onlineUser.id %}
                                {% set isOnline = true %}
                            {% endif %}
                        {% endfor %}
                        {% if isOnline %}
                            {% set currentStatus = 'online' %}
                        {% else %}
                            {% set currentStatus = 'offline' %}
                        {% endif %}
    
                        {# USER ROW #}
                        <tr class="hover:bg-neutral-800 border-b border-neutral-600">
                            <td class="text-white p-1 border-b border-neutral-600">{{ row.id|e }}</td>
                            <td class="text-white p-1 border-b border-neutral-600">
                                <a href={{ path('app_manager_users_profile', {'id': row.id}) }} class="profile-link underline">{{ row.username |e}}</a>
                            </td>
                                    
                            {# ROLE VALUE #}
                            {% if userManager.isUserAdmin(row.id) %}
                                <td class="text-red-400 p-1 border-b border-neutral-600">
                                    <a href="#" class="role-update-button underline" data-username="{{ row.username|e }}" data-role="{{ row.role|e }}" data-id="{{ row.id|e }}">{{ row.role|e }}</a>
                                </td>
                            {% else %}
                                <td class="text-green-400 p-1 border-b border-neutral-600">
                                    <a href="#" class="role-update-button underline" data-username="{{ row.username|e }}" data-role="{{ row.role|e }}" data-id="{{ row.id|e }}">{{ row.role|e }}</a>
                                </td>
                            {% endif %}
    
                            {# BROWSER VALUE #}
                            {% if row.userAgent == 'Unknown' or row.userAgent == 'DataFixtures-CLI' %}
                                <td class="text-red-400 p-1 border-b border-neutral-600">{{ visitorInfoUtil.getBrowserShortify(row.userAgent)|e }}</td>
                            {% else %}
                                <td class="text-white p-1 border-b border-neutral-600">{{ visitorInfoUtil.getBrowserShortify(row.userAgent)|e }}</td>
                            {% endif %}
                                    
                            {# OS NAME VALUE #}
                            {% if visitorInfoUtil.getOs(row.userAgent) == 'Unknown OS' %}
                                <td class="text-red-400 p-1 border-b border-neutral-600">{{ visitorInfoUtil.getOs(row.userAgent)|e }}</td>
                            {% else %}
                                <td class="text-white p-1 border-b border-neutral-600">{{ visitorInfoUtil.getOs(row.userAgent)|e }}</td>
                            {% endif %}
                                    
                            {# LAST LOGIN TIME #}
                            <td class="text-white p-1 border-b border-neutral-600">{{ row.lastLoginTime|date('Y-m-d H:i:s')|e }}</td>
                                    
                            {# IP ADDRESS VALUE #}
                            {% if currentIp == row.ipAddress %}
                                <td class="text-white p-1 border-b border-neutral-600 highlighter">{{ row.ipAddress|e }}</td>
                            {% else %}
                                <td class="text-white p-1 border-b border-neutral-600">{{ row.ipAddress|e }}</td>
                            {% endif %}

                            {# ONLINE STATUS #}
                            {% if currentStatus == 'online' %}
                                <td class="text-green-400 p-1 border-b border-neutral-600">
                                    <p>{{currentStatus|e}}</p>
                                </td>
                            {% else %}
                                <td class="text-red-400 p-1 border-b border-neutral-600">
                                    <p>{{currentStatus|e}}</p>
                                </td>
                            {% endif %}
    
                            {# BANNED STATUS #}
                            {% if banManager.isUserBanned(row.id) %}
                                <td class="text-green-400 p-1 border-b border-neutral-600">
                                    <p>Yes</p>
                                </td>
                                <td class="text-white p-1 border-b border-neutral-600 text-center">
                                    <a href={{ path('app_manager_users_ban', {'id': row.id, 'status': 'inactive'}) }} class="unban-button">UNBAN</a>
                                </td>
                            {% else %}
                                <td class="text-red-400 p-1 border-b border-neutral-600">
                                    <p>No</p>
                                </td>
                                <td class="text-white p-1 border-b border-neutral-600 text-center">
                                    <a href={{ path('app_manager_users_ban', {'id': row.id, 'status': 'active'}) }} class="ban-button">BAN</a>
                                </td>
                            {% endif %}
    
                            {# USER DELETE LINK #}
                            <td class="text-white p-1 border-b border-neutral-600">
                                <a href={{ path('app_manager_users_delete', {'id': row.id, 'page': currentPage}) }} class="delete-button">X</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
    
    {# PAGINATION SYSTEM #}
    {% if (totalUsersCount > limitPerPage) and (filter == '') %}
        <div class="mt-2 flex justify-center mb-2">
            <div class="border border-neutral-600 rounded-lg overflow-hidden">
                <ul class="flex">
                    {% set totalPages = (totalUsersCount / limitPerPage)|round(0, 'ceil') %}
                    {% set previousPage = currentPage > 1 ? currentPage - 1 : 1 %}
                    {% set nextPage = currentPage < totalPages ? currentPage + 1 : totalPages %}
                    {% set startPage = max(currentPage - 2, 1) %}
                    {% set endPage = min(currentPage + 2, totalPages) %}
                    <li>
                        <a href={{ path('app_manager_users', {'page': previousPage}) }} class="block px-4 py-2 text-white hover:bg-neutral-800 {% if currentPage == 1 %}cursor-not-allowed opacity-50{% endif %}" {% if currentPage == 1 %}disabled{% endif %}>Previous</a>
                    </li>
                    {% for page in startPage..endPage %}
                        <li>
                            <a href={{ path('app_manager_users', {'page': page}) }} class="block px-4 py-2 text-white {% if page == currentPage %}bg-neutral-800{% else %}hover:bg-neutral-800{% endif %}">{{ page }}</a>
                        </li>
                    {% endfor %}
                    <li>
                        <a href={{ path('app_manager_users', {'page': nextPage}) }} class="block px-4 py-2 text-white hover:bg-neutral-800 {% if currentPage == totalPages %}cursor-not-allowed opacity-50{% endif %}" {% if currentPage == totalPages %}disabled{% endif %}>Next</a>
                    </li>
                </ul>
            </div>
        </div>
    {% endif %}
    
    {# USER DELETE POPUP OVERLAY #}
    <div id="popup-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-neutral-900 rounded-lg p-6 border border-neutral-700">
            <p class="mb-4 text-white">Are you sure you want to delete this user?</p>
            <div class="flex justify-end">
                <button id="cancel-button" class="bg-gray-600 text-white px-4 py-2 rounded mr-2 hover:bg-gray-700">No</button>
                <button id="confirm-button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Yes</button>
            </div>
        </div>
    </div>
    
    {# USER ROLE UPDATE POPUP OVERLAY #}
    <div id="role-update-popup-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-neutral-900 rounded-lg p-6 border border-neutral-700">
            <p id="role-update-title" class="mb-4 text-white">Update role: <span id="role-update-username"></span></p>
            <form id="role-update-form" method="POST" action="{{ path('app_manager_users_role_update') }}">
                <input type="hidden" name="id" id="role-update-user-id">
                <input type="hidden" name="current-role" id="current-role">
                <div class="mb-4">
                    <label for="new-role" class="block text-white mb-2">New Role:</label>
                    <input type="text" name="role" id="new-role" class="w-full px-4 py-2 border border-neutral-700 rounded bg-neutral-800 text-white">
                </div>
                <div id="role-error-message" class="text-red-500 mb-4 hidden">The new role must be different from the current role.</div>
                <div class="flex justify-end">
                    <button type="button" id="role-update-cancel-button" class="bg-gray-600 text-white px-4 py-2 rounded mr-2 hover:bg-gray-700">Close</button>
                    <button type="submit" id="role-update-submit-button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" disabled>Update</button>
                </div>
            </form>
        </div>
    </div>
    
    {# BAN CONFIRMATION OVERLAY #}
    <div id="ban-popup-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-neutral-900 rounded-lg p-6 border border-neutral-700">
            <p class="mb-4 text-white">Enter Ban Reason:</p>
            <div class="mb-4">
                <input type="text" id="ban-reason" class="w-full px-4 py-2 border border-neutral-700 rounded bg-neutral-800 text-white">
            </div>
            <div class="flex justify-end">
                <button id="ban-cancel-button" class="bg-gray-600 text-white px-4 py-2 rounded mr-2 hover:bg-gray-700">Cancel</button>
                <button id="ban-confirm-button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Ban</button>
            </div>
        </div>
    </div>
        
    {# UNBAN CONFIRMATION OVERLAY #}
    <div id="unban-popup-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-neutral-900 rounded-lg p-6 border border-neutral-700">
            <p class="mb-4 text-white">Are you sure you want to unban this user?</p>
            <div class="flex justify-end">
                <button id="unban-cancel-button" class="bg-gray-600 text-white px-4 py-2 rounded mr-2 hover:bg-gray-700">No</button>
                <button id="unban-confirm-button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Yes</button>
            </div>
        </div>
    </div>    

    {# POPUP FUNCTIONS #}
    {{ encore_entry_script_tags('user-manager-js') }}
</div>
{% endblock %}
