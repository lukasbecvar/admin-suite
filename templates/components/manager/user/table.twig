{% extends 'common/layout.twig' %}

{#  ADMIN ACCOUNTS MANAGER COMPONENT #}
{% block component %} 
    <div class="bg-neutral-900 border-b border-neutral-700 sub-navigation">
        <a href="/manager/users/register" class="border border-neutral-500 font-bold px-1">+</a>
        <a href="#" class="border border-neutral-500 font-bold px-1">RAW</a>
        <span class="mr-1">Online {{ online_count }}/{{ total_users_count }}</span>
    </div>

    {# ACCOUNT LIST TABLE #}
    {% if users|length == 0 %}
        <p class="flex items-center justify-center mt-20 mb-20 text-2xl">This user list page is empty</p>
    {% else %}
        <div class="bg-neutral-900 border-b border-neutral-700">
            <table class="min-w-full divide-y divide-white">
                <thead>
                    <tr class="hover:bg-neutral-800 border-b border-neutral-600">
                        <th class="text-left text-white p-2">#</th>
                        <th class="text-left text-white p-2">Username</th>
                        <th class="text-left text-white p-2">Role</th>
                        <th class="text-left text-white p-2">IP Address</th>
                        <th class="text-left text-white p-2">Browser</th>
                        <th class="text-left text-white p-2">OS</th>
                        <th class="text-left text-white p-2">Last Login</th>
                        <th class="text-left text-white p-2">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white">
                    {% for row in users %}
                    <tr class="hover:bg-neutral-800 border-b border-neutral-600">
                        {# USER DATA FROM DATABASE REPOSITORY #}
                        <td class="text-white p-2 border-b border-neutral-600">{{ row.id }}</td>
                        <td class="text-white p-2 border-b border-neutral-600">{{ row.username }}</td>
                        <td class="text-white p-2 border-b border-neutral-600">{{ row.role }}</td>
                        <td class="text-white p-2 border-b border-neutral-600">{{ row.ipAddress }}</td>

                        {# USER BROWSER INFO #}
                        <td class="text-white p-2 border-b border-neutral-600">{{ visitor_info_util.getBrowserShortify(row.userAgent) }}</td>
                        <td class="text-white p-2 border-b border-neutral-600">{{ visitor_info_util.getOs(row.userAgent) }}</td>

                        {# USER LAST LOGIN TIME #}
                        <td class="text-white p-2 border-b border-neutral-600">{{ row.lastLoginTime|date('Y-m-d H:i:s') }}</td>
                        
                        {# USER ONLINE STATUS #}
                        <td class="text-white p-2 border-b border-neutral-600">
                            {% set isOnline = false %}
                            {% for onlineUser in online_list %}
                                {% if row.id == onlineUser.id %}
                                    {% set isOnline = true %}
                                {% endif %}
                            {% endfor %}
                            {% if isOnline %}
                                online
                            {% else %}
                                offline
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    {# PAGINATION BOX #}
    {% if (total_users_count > limit_per_page) and (users|length != 0) %}
        <div class="mt-2 flex justify-center mb-2">
            <div class="border border-neutral-600 rounded-lg overflow-hidden">
                <ul class="flex">
                    {% set total_pages = (total_users_count / limit_per_page)|round(0, 'ceil') %}
                    {% set previous_page = current_page > 1 ? current_page - 1 : 1 %}
                    {% set next_page = current_page < total_pages ? current_page + 1 : total_pages %}
                    
                    {# CALCULATE FIRST & LAST PAGE #}
                    {% set start_page = max(current_page - 2, 1) %}
                    {% set end_page = min(current_page + 2, total_pages) %}
                    
                    {# PREVIOUS PAGE LINK #}
                    <li>
                        <a href="{{ path('app_manager_users', {'page': previous_page}) }}" class="block px-4 py-2 text-white hover:bg-neutral-800 {% if current_page == 1 %}cursor-not-allowed opacity-50{% endif %}" {% if current_page == 1 %}disabled{% endif %}>Previous</a>
                    </li>
                    
                    {# PAGES LIST #}
                    {% for page in start_page..end_page %}
                        <li>
                            <a href="{{ path('app_manager_users', {'page': page}) }}" class="block px-4 py-2 text-white {% if page == current_page %}bg-neutral-800{% else %}hover:bg-neutral-800{% endif %}">{{ page }}</a>
                        </li>
                    {% endfor %}
                    
                    {# NEXT PAGE LINK #}
                    <li>
                        <a href="{{ path('app_manager_users', {'page': next_page}) }}" class="block px-4 py-2 text-white hover:bg-neutral-800 {% if current_page == total_pages %}cursor-not-allowed opacity-50{% endif %}" {% if current_page == total_pages %}disabled{% endif %}>Next</a>
                    </li>
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}
